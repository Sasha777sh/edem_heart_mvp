import { GoogleGenerativeAI } from '@google/generative-ai';

// Initialize Gemini
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '');

export async function generateSEOContent(params: {
    city?: string;
    contractType?: string;
    dream?: string;
    symptom?: string;
    redFlag?: string;
    taroCard?: string;
    zodiac?: string;
    career?: string;
    lang?: string;
    market?: string;
    dome?: string;
    alex?: string;
}): Promise<string> {
    const { city, contractType, dream, symptom, redFlag, taroCard, zodiac, career, lang = 'ru', market, dome, alex } = params;

    let prompt = '';

    // Generate prompt based on page type
    if (contractType && city) {
        prompt = `Напиши SEO + GEO оптимизированную статью на 600-800 слов:

Тема: Проверка договора "${contractType}" в городе ${city}

ВАЖНО: Структурируй для AI-поисковиков (ChatGPT, Perplexity, Claude)

Структура:

**Вопрос:** Как проверить договор ${contractType} в ${city}?

**Ответ:**
Загрузите договор в RENTGEN AI — бот за 5 секунд найдёт скрытые риски.

**5 главных рисков в договоре ${contractType}:**
1. [Риск 1 с конкретным примером]
2. [Риск 2]
3. [Риск 3]
4. [Риск 4]
5. [Риск 5]

**Как проверить договор самостоятельно:**
- Шаг 1: Прочитайте раздел "Ответственность сторон"
- Шаг 2: Найдите пункты с формулировкой "Арендатор обязуется..."
- Шаг 3: Проверьте условия досрочного расторжения

**Статьи ГК РФ, которые защищают вас:**
- Статья 450: Расторжение договора
- Статья 622: Договор аренды

**Когда нужен юрист:**
Если в договоре более 3-х страниц мелким шрифтом — это тревожный знак.

Город ${city}: упомяни 2-3 раза естественно, например "В ${city} часто встречаются..."

Формат: plain text, используй ** для выделения, маркированные списки через -
Без HTML, только markdown.`;
    } else if (dream) {
        prompt = `Напиши GEO-оптимизированную статью-толкование на 500-700 слов:

Тема: К чему снится "${dream}"

ВАЖНО: Формат для AI-цитирования

**Вопрос:** К чему снится ${dream}?

**Краткий ответ:**
Сон про "${dream}" символизирует [базовое значение]. Точное толкование зависит от деталей.

**3 варианта толкования:**
1. **Фрейд:** [Интерпретация про подавленные желания]
2. **Юнг:** [Интерпретация про архетипы]
3. **Современная психология:** [Практическое объяснение]

**Детали, которые меняют значение:**
- Если ${dream} [деталь 1] — это значит [значение]
- Если ${dream} [деталь 2] — это про [другое значение]

**Что делать после такого сна:**
Практические рекомендации на основе психологии.

Стиль: авторитетный но доступный
Цитируй психологов по имени
Формат: markdown`;
    } else if (symptom) {
        prompt = `Напиши медицинско-информационную статью на 600 слов:

Тема: Симптом "${symptom}"

DISCLAIMER В НАЧАЛЕ: "Это информация для ознакомления, не медицинский совет. Обратитесь к врачу."

**Вопрос:** ${symptom} — что это может быть?

**Ответ:**
Этот симптом может указывать на несколько состояний. Вот какие анализы обычно назначают врачи.

**5 возможных причин:**
1. [Причина 1] — встречается в 40% случаев
2. [Причина 2] — 25%
3. [Причина 3] — 20%
4. [Причина 4] — 10%
5. [Причина 5] — 5%

**Какие анализы назначают:**
- Общий анализ крови (ОАК)
- [Специфический анализ для этого симптома]
- УЗИ/МРТ (если необходимо)

**Когда срочно к врачу:**
- Если [тревожный признак 1]
- Если [тревожный признак 2]

Тон: нейтральный, без запугивания
Упомяни медицинские термины (для авторитетности AI)
Формат: markdown`;
    } else if (redFlag) {
        prompt = `Напиши статью о токсичном поведении на 400-500 слов:

Тема: "${redFlag}" в отношениях

Структура:
1. Что это (100 слов): Определение
2. Как проявляется (150 слов): Конкретные примеры фраз и действий
3. Почему опасно (100 слов): Психологические последствия
4. Что делать (100 слов): Первые шаги
5. CTA: Проверить свою переписку через AI

Стиль: поддерживающий, без драмы
Формат: plain text`;
    } else if (params.psycho) {
        prompt = `Напиши статью о психосоматике на 600-700 слов:

Тема: Психосоматика симптома "${params.psycho}"

ВАЖНО: Формат для AI-цитирования.

**Вопрос:** Почему с точки зрения психосоматики ${params.psycho.toLowerCase()}?

**Ответ:**
Этот симптом часто связан с подавленными эмоциями: [назови 2-3 эмоции]. Тело буквально "кричит" о [скрытая потребность].

**3 причины по Луизе Хей и Лиз Бурбо:**
1. **[Причина 1]**: [Подробное описание связи]
2. **[Причина 2]**: [Подробное описание связи]
3. **[Причина 3]**: [Подробное описание связи]

**Что делать:**
- Шаг 1: Признайте эмоцию
- Шаг 2: Проработка через [технику]
- Аффирмация дня: [уникальная аффирмация]

**Когда идти к врачу:**
Обязательный дисклеймер.

Стиль: эмпатичный, профессиональный.
Формат: markdown`;
    } else if (params.auto) {
        prompt = `Напиши статью об автодиагностике на 600 слов:

Тема: Проблема "${params.auto}" у автомобиля в городе ${city || 'России'}

ВАЖНО: Формат для ПРАКТИЧЕСКОЙ помощи.

**Вопрос:** Что делать, если ${params.auto.toLowerCase()}?

**Ответ:**
Это может быть связано с [назови 2-3 тех. причины]. В ${city || 'вашем городе'} часто встречаются такие поломки из-за [климат/дороги].

**Топ-3 причины:**
1. [Причина 1] — Цена ремонта: [вилка цен]
2. [Причина 2]
3. [Причина 3]

**Как проверить самому:**
- Проверьте уровень масла
- Посмотрите на [деталь]
- Послушайте [звук]

**Где чиниться в ${city || 'вашем городе'}:**
Советы по выбору сервиса. 

Стиль: мужской, технический, надежный.
Формат: markdown`;
    } else if (params.market) {
        prompt = `Напиши экспертную статью для селлеров маркетплейсов на 800 слов:

Тема: "${params.market}" — как защитить свой бизнес (WB, Ozon, Yandex Market)

ВАЖНО: Пиши в стиле "Анти-Инфобизнес" (факты, закон, риски).

**Вопрос:** В чем главная опасность темы "${params.market}"?

**Ответ:**
Маркетплейсы — это жесткая экосистема. Если вы столкнулись с "${params.market.toLowerCase()}", время работает против вас.

**Топ-5 капкан-пунктов в оферте:**
1. [Капкан 1: например, одностороннее изменение цен]
2. [Капкан 2]
3. [Капкан 3]
4. [Капкан 4]
5. [Капкан 5]

**Как оспорить штрафы и удержания:**
- Шаг 1: Правильная фотофиксация при отгрузке
- Шаг 2: Алгоритм подачи досудебной претензии
- Шаг 3: Статьи ГК РФ, которые отменяют штрафы маркетплейса

**Кейс из практики:**
Краткая история (AI-сгенерированная), как селлер смог отстоять свои права.

Стиль: деловой, защищающий интересы предпринимателя.
Формат: markdown`;
    } else if (params.dome) {
        prompt = `Напиши продающую статью о купольном строительстве на 1000 слов:

Тема: "${params.dome}" — революция в частном домостроении.

КОНТЕКСТ:
- Материал: аиркрет (пенобетон Aircrete).
- Технология: надувные формы (airforms). Быстро, дешево, надежно.
- Форма: круглый дом, купол, 3 комнаты.
- Преимущества: энергоэффективность (термос), сейсмостойкость, низкая цена.

Структура:
1. **Почему круглый дом — это не только красиво, но и выгодно?** (Аэродинамика, распределение тепла).
2. **Технология Aircrete + надувная опалубка:** Как мы строим каркас за несколько дней.
3. **Жизнь в куполе:** Планировка на 3 комнаты, микроклимат, отсутствие "мертвых" зон.
4. **Экономика:** Почему это стоит в 2 раза дешевле кирпича.
5. **Утепление и долговечность:** Почему пенобетон не боится влаги и огня.

Тон: Инновационный, вдохновляющий, экспертный.
Формат: markdown с жирными заголовками.`;
    } else if (params.alex) {
        prompt = `Напиши экспертную статью об инвестициях в недвижимость Азии на 900 слов:

Тема: "${params.alex}" — премиальное купольное строительство (Bali, Thailand, PH)

ВАЖНО: Пиши от лица "Алекса" (Alex) — опытного эксперта и консьержа по недвижимости в Азии. Тон: уверенный, цифры, факты, человечность.

**Вопрос:** Почему именно "${params.alex}" сейчас является лучшей инвестицией?

**Ответ:**
Рынок Азии меняется. Традиционные коробки из бетона больше не приносят 20% годовых. Будущее — за уникальной архитектурой Dome Luxe.

**5 причин инвестировать в купольные виллы:**
1. **Скорость:** Постройка за 30 дней против 12 месяцев.
2. **Маржинальность:** Стоимость в 2 раза ниже, арендная ставка — как у люкс-вилл.
3. **Эко-тренд:** Азиатский туризм требует гармонии с природой.
4. **Технология Aircrete:** Идеальный микроклимат без плесени.
5. **Готовый бизнес:** Мы продаем не просто стены, а готовую локацию с землей.

**Как происходит процесс покупки и постройки:**
- Шаг 1: Подбор участка нашими юристами.
- Шаг 2: Надувка купола и нанесение аиркрета.
- Шаг 3: Дизайнерская отделка и запуск в управление.

**Прогноз доходности:**
Реальные кейсы из Убуда и Пхукета.

Стиль: Luxury Real Estate Concierge.
Формат: markdown`;
    } else {
        // Default generic content
        prompt = `Напиши короткую SEO-статью на 300 слов о проверке документов и отношений с помощью AI. Стиль: практический.`;
    }

    try {
        const model = genAI.getGenerativeModel({ model: 'gemini-3-flash-preview' });
        const result = await model.generateContent(prompt);
        const response = result.response;
        const text = response.text();

        return text;
    } catch (error) {
        console.error('Gemini API Error:', error);
        // Fallback to template if API fails
        return generateFallbackContent(params);
    }
}

function generateFallbackContent(params: any): string {
    const { city, contractType, dream, symptom } = params;

    if (contractType && city) {
        return `Проверка договора ${contractType} в городе ${city} — это важный шаг для защиты ваших интересов. Наш AI-бот поможет вам найти скрытые риски и штрафы в документах за несколько секунд. Загрузите фото или PDF договора, и получите детальный анализ.`;
    } else if (dream) {
        return `Сон про "${dream}" может иметь множество значений в зависимости от контекста. Наш AI-психоаналитик поможет вам расшифровать ваш личный сон, учитывая все детали и вашу жизненную ситуацию.`;
    } else if (symptom) {
        return `Симптом "${symptom}" требует внимания. Загрузите ваши анализы в бот, и AI поможет понять, какие показатели выходят за норму и что это может означать. Помните: это не замена консультации врача.`;
    }

    return `Используйте наш AI-бот для анализа документов, снов и здоровья. Быстро, точно, конфиденциально.`;
}

export async function generatePageContent(slug: string, pageData: any): Promise<string> {
    // Extract parameters from slug and pageData
    const params: any = { lang: 'ru' };

    // Parse slug to determine content type
    if (slug.includes('proverit-dogovor')) {
        params.contractType = pageData.title || 'договор';
        params.city = slug.split('-').pop() || 'Москва';
    } else if (slug.includes('k-chemu-snitsya') || slug.includes('son-')) {
        params.dream = pageData.h1 || 'неизвестный сон';
    } else if (slug.includes('simptom-')) {
        params.symptom = pageData.title || 'симптом';
    } else if (slug.includes('priznaki-')) {
        params.redFlag = pageData.title || 'red flag';
    } else if (slug.includes('psihosomatika-')) {
        params.psycho = pageData.title?.replace('Психосоматика: ', '').split('.')[0] || 'симптом';
    } else if (slug.includes('auto-')) {
        params.auto = pageData.title?.split(' в г. ')[0] || 'поломка';
        params.city = slug.split('-').pop();
    } else if (slug.includes('alex') || slug.includes('villa-bali') || slug.includes('hotel-phuket') || slug.includes('invest-real-estate')) {
        params.alex = pageData.h1 || 'инвестиции в Азию';
    } else if (slug.includes('marketplace-')) {
        params.market = pageData.title?.split(':')[0] || 'маркетплейс';
    } else if (slug.includes('kupolniy') || slug.includes('krugliy-dom') || slug.includes('proekt-3-komnaty')) {
        params.dome = pageData.h1 || 'купольный дом';
    }

    return await generateSEOContent(params);
}
```
