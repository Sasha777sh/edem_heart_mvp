import google.generativeai as genai
import json
import os
from enum import Enum
from typing import Dict, Optional

class ShadowStrategy(Enum):
    JUSTIFIER = "ÐžÐ¿Ñ€Ð°Ð²Ð´Ñ‹Ð²Ð°ÑŽÑ‰Ð¸Ð¹ÑÑ"
    FOOL = "Ð“Ð»ÑƒÐ¿ÐµÑ†"
    AGGRESSOR = "ÐÐ³Ñ€ÐµÑÑÐ¾Ñ€"
    FOLLOWER = "Ð’ÐµÐ´Ð¾Ð¼Ñ‹Ð¹"
    ACCUSED = "ÐžÐ±Ð²Ð¸Ð½ÑÐµÐ¼Ñ‹Ð¹"
    STUDENT = "Ð£Ñ‡ÐµÐ½Ð¸Ðº"
    JUDGE = "Ð¡ÑƒÐ´ÑŒÑ"
    CHAOS = "Ð¥Ð°Ð¾Ñ"
    VICTIM = "Ð–ÐµÑ€Ñ‚Ð²Ð°"
    PROVOCATEUR = "ÐŸÑ€Ð¾Ð²Ð¾ÐºÐ°Ñ‚Ð¾Ñ€"
    SKEPTIC = "Ð¡ÐºÐµÐ¿Ñ‚Ð¸Ðº"
    PSEUDO_ALLY = "ÐŸÑÐµÐ²Ð´Ð¾-ÑÐ¾ÑŽÐ·Ð½Ð¸Ðº"

class FieldReader:
    def __init__(self, api_key: str = None):
        # Fallback to the key seen in other files if not provided (for development speed)
        # In production, this should come from env.
        self.api_key = api_key or "AIzaSyAVcKK5KcpduBv2hh-uvMreDGvTHX-uURE" 
        genai.configure(api_key=self.api_key)
        self.model = genai.GenerativeModel('gemini-2.0-flash')

    PROMPTS = {
        "communication": """
Ð¢Ñ‹ â€” SHADOW READER (Ð¢ÐµÐ½ÐµÐ²Ð¾Ð¹ ÐÐ½Ð°Ð»Ð¸Ñ‚Ð¸Ðº). Ð’ÑÐºÑ€Ñ‹Ð²Ð°Ð¹ ÑÐºÑ€Ñ‹Ñ‚ÑƒÑŽ Ð´Ð¸Ð½Ð°Ð¼Ð¸ÐºÑƒ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð°.
Ð¢Ð’ÐžÐ¯ Ð¦Ð•Ð›Ð¬: ÐŸÐ¾Ð½ÑÑ‚ÑŒ, ÐºÐ°ÐºÑƒÑŽ Ñ€Ð¾Ð»ÑŒ Ð½Ð°Ð²ÑÐ·Ñ‹Ð²Ð°ÑŽÑ‚ Ð¸ Ñ‡ÐµÐ³Ð¾ Ð´Ð¾Ð±Ð¸Ð²Ð°ÑŽÑ‚ÑÑ.

Ð¤ÐžÐ ÐœÐÐ¢ Ð’Ð«Ð’ÐžÐ”Ð (JSON):
{
    "behavior": "Ð§Ð¢Ðž ÐžÐ Ð”Ð•Ð›ÐÐ•Ð¢. (ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: 'ÐÐµ ÑÐ¿Ð¾Ñ€Ð¸Ñ‚ Ñ Ñ„Ð°ÐºÑ‚Ð°Ð¼Ð¸, Ð° Ð±ÑŒÐµÑ‚ Ð½Ð° ÑÐ¼Ð¾Ñ†Ð¸Ð¸')",
    "imposed_role": "ÐšÐÐšÐ£Ð® Ð ÐžÐ›Ð¬ ÐÐÐ’Ð¯Ð—Ð«Ð’ÐÐ•Ð¢. (ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: 'ÐžÐ¿Ñ€Ð°Ð²Ð´Ñ‹Ð²Ð°ÑŽÑ‰Ð¸Ð¹ÑÑ', 'Ð¡Ð¿Ð°ÑÐ°Ñ‚ÐµÐ»ÑŒ')",
    "hidden_motivation": "Ð¡ÐšÐ Ð«Ð¢ÐÐ¯ Ð’Ð«Ð“ÐžÐ”Ð. (ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: 'ÐŸÐ¾Ð´Ð½ÑÑ‚ÑŒ ÑÐ°Ð¼Ð¾Ð¾Ñ†ÐµÐ½ÐºÑƒ Ð·Ð° Ñ‚Ð²Ð¾Ð¹ ÑÑ‡ÐµÑ‚')",
    "fear": "Ð¡ÐšÐ Ð«Ð¢Ð«Ð™ Ð¡Ð¢Ð ÐÐ¥.",
    "recommendation": "Ð¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð¯ ÐžÐ¢Ð’Ð•Ð¢Ð (Ð˜Ð³Ð½Ð¾Ñ€ / Ð—ÐµÑ€ÐºÐ°Ð»Ð¾ / Ð’ÑÐºÑ€Ñ‹Ñ‚Ð¸Ðµ)."
}
""",
        "negotiation": """
Ð¢Ñ‹ â€” CONTRACT ANALYST (ÐÐ½Ð°Ð»Ð¸Ñ‚Ð¸Ðº ÐšÐ¾Ð½Ñ‚Ñ€Ð°ÐºÑ‚Ð°).
Ð¢Ð’ÐžÐ¯ Ð¦Ð•Ð›Ð¬: ÐÐ°Ð¹Ñ‚Ð¸ Ñ€Ð¸ÑÐºÐ¸ Ð² Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸ Ð¸Ð»Ð¸ Ð¿Ð¸ÑÑŒÐ¼Ðµ Ð¿Ð°Ñ€Ñ‚Ð½ÐµÑ€Ð°/ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°.
Ð¢Ð’ÐžÐ¯ Ð—ÐÐ”ÐÐ§Ð: ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ, Ð³Ð´Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ Ð½ÐµÑÐ¸Ð¼Ð¼ÐµÑ‚Ñ€Ð¸Ñ‡Ð½Ñ‹ Ð¸ Ð³Ð´Ðµ ÑÐºÑ€Ñ‹Ñ‚Ñ‹ ÑƒÐ±Ñ‹Ñ‚ÐºÐ¸.

Ð¤ÐžÐ ÐœÐÐ¢ Ð’Ð«Ð’ÐžÐ”Ð (JSON):
{
    "behavior": "ðŸ”´ Ð Ð˜Ð¡Ðš (ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'Ð¦ÐµÐ½Ð° Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð°, Ð° Ð¾Ð±ÑŠÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‚ Ð¿Ð»Ð°Ð²Ð°ÑŽÑ‰Ð¸Ð¹')",
    "imposed_role": "âš–ï¸ ÐÐ¡Ð˜ÐœÐœÐ•Ð¢Ð Ð˜Ð¯ (ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'ÐŸÑ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð° 100%, Ð½Ð¾ Ð½ÐµÑ‚ ÑÐ°Ð½ÐºÑ†Ð¸Ð¹ Ð·Ð° ÑÑ€Ñ‹Ð² ÑÑ€Ð¾ÐºÐ¾Ð²')",
    "hidden_motivation": "ðŸ•³ Ð¡Ð›Ð•ÐŸÐžÐ• ÐœÐ•Ð¡Ð¢Ðž (Ð§Ñ‚Ð¾ Ð½Ðµ Ð¿Ñ€Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¾? ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'ÐÐµÑ‚ SLA Ð¸ Ð¿Ñ€Ð¾Ñ†ÐµÐ´ÑƒÑ€Ñ‹ Ð¿Ñ€Ð¸ÐµÐ¼ÐºÐ¸')",
    "fear": "ðŸ’° Ð”Ð•ÐÐ¬Ð“Ð˜/Ð Ð•Ð¡Ð£Ð Ð¡ (ÐšÑ‚Ð¾ Ð²Ñ‹Ð¸Ð³Ñ€Ñ‹Ð²Ð°ÐµÑ‚? ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'Ð’Ñ‹Ð³Ð¾Ð´Ð½Ð¾ Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÑƒ, Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŽ â€” ÐºÐ°ÑÑÐ¾Ð²Ñ‹Ð¹ Ñ€Ð°Ð·Ñ€Ñ‹Ð²')",
    "recommendation": "ðŸŽ¯ Ð’Ð•Ð Ð”Ð˜ÐšÐ¢ (ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ñ‚ÑŒ Ñ„Ð¸ÐºÑÐ°Ñ†Ð¸Ð¸ Ð¾Ð±ÑŠÐµÐ¼Ð° Ð¸Ð»Ð¸ Ð¿Ð¾Ñ‡Ð°ÑÐ¾Ð²ÑƒÑŽ Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ')"
}
""",
        "competitor": """
Ð¢Ñ‹ â€” MARKET AUDITOR (ÐÑƒÐ´Ð¸Ñ‚Ð¾Ñ€ Ð Ñ‹Ð½ÐºÐ°).
Ð¢Ð’ÐžÐ¯ Ð¦Ð•Ð›Ð¬: ÐÐ°Ð¹Ñ‚Ð¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð½Ñ‹Ðµ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸ ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ð°.
Ð¢Ð’ÐžÐ¯ Ð—ÐÐ”ÐÐ§Ð: ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ, Ð³Ð´Ðµ Ñ€Ñ‹Ð½Ð¾Ðº "Ñ‚ÐµÑ‡ÐµÑ‚" Ð¸ Ð³Ð´Ðµ ÐµÑÑ‚ÑŒ Ñ€Ñ‹Ñ‡Ð°Ð³ Ð´Ð»Ñ Ñ€Ð¾ÑÑ‚Ð°.

Ð—ÐÐŸÐ Ð•Ð©Ð•ÐÐž:
- ÐŸÐ¸ÑÐ°Ñ‚ÑŒ 'ÑƒÐ±Ð¸Ñ‚ÑŒ', 'ÑƒÐ½Ð¸Ñ‡Ñ‚Ð¾Ð¶Ð¸Ñ‚ÑŒ', 'Ð¼Ð¾ÑˆÐµÐ½Ð½Ð¸ÐºÐ¸'.
- ÐžÑ†ÐµÐ½Ð¸Ð²Ð°Ñ‚ÑŒ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ.

Ð¤ÐžÐ ÐœÐÐ¢ Ð’Ð«Ð’ÐžÐ”Ð (JSON):
{
    "behavior": "ðŸ”´ Ð Ð˜Ð¡Ðš Ð Ð«ÐÐšÐ (ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'Ð’Ñ‹ÑÐ¾ÐºÐ°Ñ Ñ†ÐµÐ½Ð° Ð¿Ñ€Ð¸ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ð¸ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°')",
    "imposed_role": "âš–ï¸ ÐÐ¡Ð˜ÐœÐœÐ•Ð¢Ð Ð˜Ð¯ (ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð¿Ð»Ð°Ñ‚Ð¸Ñ‚ Ð·Ð°Ñ€Ð°Ð½ÐµÐµ, Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½ÐµÑÐµÑ‚ ÑÐ°Ð½ÐºÑ†Ð¸Ð¹')",
    "hidden_motivation": "ðŸ•³ Ð¡Ð›Ð•ÐŸÐžÐ• ÐœÐ•Ð¡Ð¢Ðž (Ð§Ñ‚Ð¾ ÑƒÐ¿ÑƒÑ‰ÐµÐ½Ð¾? ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ SLA Ð¸ ÐºÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¸ Ð¿Ñ€Ð¸ÐµÐ¼ÐºÐ¸')",
    "fear": "â–¶ï¸ Ð Ð«Ð§ÐÐ“ Ð ÐžÐ¡Ð¢Ð (ÐšÐ°Ðº Ð·Ð°Ð±Ñ€Ð°Ñ‚ÑŒ Ñ€Ñ‹Ð½Ð¾Ðº? ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'Ð’Ð²ÐµÑÑ‚Ð¸ Ð¿Ð¾ÑÑ‚Ð°Ð¿Ð½ÑƒÑŽ Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ Ð¸ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ SLA')",
    "recommendation": "ðŸŽ¯ Ð Ð«ÐÐžÐ§ÐÐ«Ð™ Ð’Ð«Ð’ÐžÐ” (ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'Ð¡ÐµÐ³Ð¼ÐµÐ½Ñ‚ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ½ Ðº Ð¿Ñ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ð¾ÑÑ‚Ð¸. Ð Ñ‹Ð½Ð¾Ðº Ð½Ðµ Ð·Ð°Ñ‰Ð¸Ñ‰ÐµÐ½.')"
}
""",
        "marketplace": """
Ð¢Ñ‹ â€” E-COM AUDITOR (ÐÑƒÐ´Ð¸Ñ‚Ð¾Ñ€ Ð¢Ð¾Ð²Ð°Ñ€Ð°).
Ð¢Ð’ÐžÐ¯ Ð¦Ð•Ð›Ð¬: ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÑƒ Ñ‚Ð¾Ð²Ð°Ñ€Ð° (WB/Ozon/Amazon).
Ð¢Ð’ÐžÐ¯ Ð—ÐÐ”ÐÐ§Ð: ÐÐ°Ð¹Ñ‚Ð¸ Ñ€Ð°Ð·Ñ€Ñ‹Ð² Ð¼ÐµÐ¶Ð´Ñƒ "ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸ÐµÐ¼" (ÐšÐ¾Ð½Ñ‚ÐµÐ½Ñ‚) Ð¸ "Ð ÐµÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒÑŽ" (ÐžÑ‚Ð·Ñ‹Ð²Ñ‹/Ð¥Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ¸).

Ð¤ÐžÐ ÐœÐÐ¢ Ð’Ð«Ð’ÐžÐ”Ð (JSON):
{
    "behavior": "ðŸ“¸ VISUAL GAP (Ð’Ð¸Ð·ÑƒÐ°Ð». ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'ÐÐ° Ñ„Ð¾Ñ‚Ð¾ Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼, Ð² Ð¾Ñ‚Ð·Ñ‹Ð²Ð°Ñ… Ð¶Ð°Ð»ÑƒÑŽÑ‚ÑÑ Ð½Ð° Ð´ÐµÑˆÐµÐ²Ñ‹Ð¹ Ð¿Ð»Ð°ÑÑ‚Ð¸Ðº')",
    "imposed_role": "ðŸ’¬ REVIEW GAP (Ð‘Ð¾Ð»Ð¸. ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'Ð’ÑÐµ ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ñ‹ Ð¸Ð¼ÐµÑŽÑ‚ Ð¶Ð°Ð»Ð¾Ð±Ñƒ Ð½Ð° Ð¼Ð¾Ð»Ð½Ð¸ÑŽ. Ð­Ñ‚Ð¾ ÑˆÐ°Ð½Ñ.')",
    "hidden_motivation": "ðŸ“‰ SEO/OFFER (ÐŸÑ€Ð¾ÑÐ°Ð´ÐºÐ°. ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ð¿ÐµÑ€ÐµÑÐ¿Ð°Ð¼Ð»ÐµÐ½, ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ ÑÐ¼Ñ‹ÑÐ»Ñ‹ Ñ€Ð°Ð·Ð¼Ñ‹Ñ‚Ñ‹')",
    "fear": "ðŸ’° UNIT ECONOMICS (Ð“Ð¸Ð¿Ð¾Ñ‚ÐµÐ·Ð°. ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'Ð”ÐµÐ¼Ð¿Ð¸Ð½Ð³. Ð’ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾, Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚ Ð² Ð½Ð¾Ð»ÑŒ Ñ€Ð°Ð´Ð¸ Ð¾Ñ‚Ð·Ñ‹Ð²Ð°.')",
    "recommendation": "ðŸš€ Ð¢ÐžÐ§ÐšÐ Ð’Ð¥ÐžÐ”Ð (Ð§Ñ‚Ð¾ ÑƒÐ»ÑƒÑ‡ÑˆÐ¸Ñ‚ÑŒ? ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'Ð¡Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ð³Ñ€Ð°Ñ„Ð¸ÐºÑƒ Ñ ÑƒÐ¿Ð¾Ñ€Ð¾Ð¼ Ð½Ð° Ð¿Ñ€Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ Ð¼Ð¾Ð»Ð½Ð¸Ð¸')"
}
""",
        "hr": """
Ð¢Ñ‹ â€” HR RISK CALCULATOR (ÐšÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€ Ð Ð¸ÑÐºÐ¾Ð² ÐÐ°Ð¹Ð¼Ð°).
Ð¢Ð’ÐžÐ¯ Ð¦Ð•Ð›Ð¬: ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ€ÐµÐ·ÑŽÐ¼Ðµ/ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸ÑŽ Ð½Ðµ ÐºÐ°Ðº Ð¿ÑÐ¸Ñ…Ð¾Ð»Ð¾Ð³, Ð° ÐºÐ°Ðº Ð±Ð¸Ð·Ð½ÐµÑ-Ð¿Ð°Ñ€Ñ‚Ð½ÐµÑ€.
Ð¢Ð’ÐžÐ¯ Ð—ÐÐ”ÐÐ§Ð: ÐÐ°Ð¹Ñ‚Ð¸ Ð½ÐµÑÐ¾Ð²Ð¿Ð°Ð´ÐµÐ½Ð¸Ðµ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ð¹, Ñ€Ð¸ÑÐºÐ¸ Ð´Ð»Ñ Ð±Ð¸Ð·Ð½ÐµÑÐ° Ð¸ Ñ†ÐµÐ½Ñƒ Ð¾ÑˆÐ¸Ð±ÐºÐ¸.

Ð—ÐÐŸÐ Ð•Ð©Ð•ÐÐž:
- ÐŸÐ¸ÑÐ°Ñ‚ÑŒ Ð¿Ñ€Ð¾ Ð»Ð¸Ñ‡Ð½Ð¾ÑÑ‚ÑŒ ("Ð¾Ð½ Ð»ÐµÐ½Ð¸Ð²Ñ‹Ð¹", "Ð¾Ð½ Ð±Ð¾Ð¸Ñ‚ÑÑ").
- Ð”Ð°Ð²Ð°Ñ‚ÑŒ Ð¿ÑÐ¸Ñ…Ð¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¾Ñ†ÐµÐ½ÐºÐ¸.
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ñ‹.

Ð¤ÐžÐ ÐœÐÐ¢ Ð’Ð«Ð’ÐžÐ”Ð (JSON):
{
    "behavior": "ðŸ”´ Ð Ð˜Ð¡Ðš (ÐÐµÑÐ¾Ð²Ð¿Ð°Ð´ÐµÐ½Ð¸Ðµ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ð¹ Ð¿Ð¾ Ð·Ð¾Ð½Ðµ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸. ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'ÐšÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚ ÑÐºÑÐ¿ÐµÑ€Ñ‚, Ñ€Ð¾Ð»ÑŒ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð°Ñ')",
    "imposed_role": "âš–ï¸ ÐÐ¡Ð˜ÐœÐœÐ•Ð¢Ð Ð˜Ð¯ (Ð“Ð´Ðµ Ð±Ð°Ð»Ð°Ð½Ñ Ð½Ð°Ñ€ÑƒÑˆÐµÐ½? ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'ÐšÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ñ Ð¶Ð´ÐµÑ‚ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ñ‚Ð¸Ð²Ñƒ, Ð² Ñ€ÐµÐ·ÑŽÐ¼Ðµ â€” Ñ„Ð¾ÐºÑƒÑ Ð½Ð° Ð¿Ñ€Ð¾Ñ†ÐµÑÑ')",
    "hidden_motivation": "ðŸ•³ Ð¡Ð›Ð•ÐŸÐžÐ• ÐœÐ•Ð¡Ð¢Ðž (Ð§Ñ‚Ð¾ Ð½Ðµ Ð·Ð°Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¾? ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'ÐÐµ ÑÑÐ½Ñ‹ ÐºÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð° Ñ‡ÐµÑ€ÐµÐ· 90 Ð´Ð½ÐµÐ¹')",
    "fear": "ðŸ’° Ð¦Ð•ÐÐ ÐžÐ¨Ð˜Ð‘ÐšÐ˜ (Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð½Ð°Ð¹Ð¼Ð° + Ð¿Ð¾Ñ‚ÐµÑ€Ñ Ñ‚ÐµÐ¼Ð¿Ð°. ÐŸÑ€Ð¸Ð¼ÐµÑ€: '2-4 Ð¾ÐºÐ»Ð°Ð´Ð° + 2 Ð¼ÐµÑÑÑ†Ð° Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ñ')",
    "recommendation": "â“ ÐšÐ›Ð®Ð§Ð•Ð’ÐžÐ™ Ð’ÐžÐŸÐ ÐžÐ¡ (ÐžÐ´Ð¸Ð½ Ð¶ÐµÑÑ‚ÐºÐ¸Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²ÑÐºÑ€Ñ‹Ñ‚ÑŒ Ñ€Ð¸ÑÐº. ÐŸÑ€Ð¸Ð¼ÐµÑ€: 'ÐšÐ°ÐºÐ¸Ðµ KPI ÑÑ‡Ð¸Ñ‚Ð°ÑŽÑ‚ÑÑ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¼Ð¸ Ñ‡ÐµÑ€ÐµÐ· 3 Ð¼ÐµÑÑÑ†Ð°?')"
}
"""
    }

    def perform_live_search(self, query: str) -> str:
        """
        Performs a Google Search to get live context.
        """
        try:
            from googlesearch import search
            results = []
            # Search for pricing, problems, and reviews
            search_queries = [
                f"site:{query} pricing cost",
                f"{query} reviews problems scam",
                f"{query} competitors alternatives"
            ]
            
            context_data = "ðŸ” LIVE WEB SIGNAL (ÐÐ°Ð¹Ð´ÐµÐ½Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¸Ð· Google):\n"
            
            for q in search_queries:
                for result in search(q, num_results=2, advanced=True):
                    context_data += f"- [{result.title}]({result.url}): {result.description}\n"
            
            return context_data
        except ImportError:
            return "âš ï¸ Google Search module not found."
        except Exception as e:
            return f"âš ï¸ Search Error: {e}"

    def analyze_content(self, text: str = "", image_data = None, context: str = "", mode: str = "communication") -> dict:
        """
        Analyzes text OR image using the specified mode.
        If text looks like a domain/company name and mode is 'competitor', performs auto-search.
        """
        user_context = context
        
        # AUTO-WEB-SEARCH TRIGGER (Competitor + Marketplace)
        if (mode == "competitor" or mode == "marketplace") and text and len(text.split()) < 3 and ("." in text or "http" in text):
             print(f"ðŸ“¡ Detected Domain/Link: {text}. Scanning Web...")
             web_context = self.perform_live_search(text)
             user_context += f"\n\n{web_context}"

        system_prompt = self.PROMPTS.get(mode, self.PROMPTS["communication"])
        
        full_prompt = [f"{system_prompt}\n\n"]
        
        if user_context:
            full_prompt.append(f"ÐšÐžÐÐ¢Ð•ÐšÐ¡Ð¢:\n{user_context}\n\n")
            
        if text:
            full_prompt.append(f"Ð’Ð¥ÐžÐ”ÐÐžÐ™ Ð¢Ð•ÐšÐ¡Ð¢:\n{text}")
            
        if image_data:
            full_prompt.append("ÐŸÐ ÐžÐÐÐÐ›Ð˜Ð—Ð˜Ð Ð£Ð™ Ð­Ð¢Ðž Ð˜Ð—ÐžÐ‘Ð ÐÐ–Ð•ÐÐ˜Ð• (Ð¡ÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚ Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÐºÐ¸, Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð¸Ð»Ð¸ Ñ€ÐµÐ·ÑŽÐ¼Ðµ). Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ OCR Ð¼Ð¾Ð´ÐµÐ»Ð¸, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð²ÐµÑÑŒ Ñ‚ÐµÐºÑÑ‚.")
            full_prompt.append(image_data)
        
        try:
            response = self.model.generate_content(full_prompt)
            # Clean up response if it contains markdown code blocks
            # ... (rest of logic)
            clean_text = response.text.strip()
            if clean_text.startswith("```json"):
                clean_text = clean_text[7:]
            if clean_text.endswith("```"):
                clean_text = clean_text[:-3]
            
            return json.loads(clean_text)
            
        except Exception as e:
            return {
                "error": str(e),
                "fallback": "ÐÐ½Ð°Ð»Ð¸Ð· Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÑ. Ð¡Ð²ÑÐ·ÑŒ Ñ ÐŸÐ¾Ð»ÐµÐ¼ Ð¿Ñ€ÐµÑ€Ð²Ð°Ð½Ð°."
            }

if __name__ == "__main__":
    # Quick sanity check
    reader = FieldReader()
    sample_text = "ÐÑƒ Ð¸ Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ ÑÑ‚Ð¸Ð¼ Ñ…Ð¾Ñ‚ÐµÐ» ÑÐºÐ°Ð·Ð°Ñ‚ÑŒ? Ð¯ Ð²Ð¾Ð¾Ð±Ñ‰Ðµ Ð½Ðµ Ð²Ð¸Ð¶Ñƒ Ñ‚ÑƒÑ‚ Ð»Ð¾Ð³Ð¸ÐºÐ¸, Ð¾Ð±ÑŠÑÑÐ½Ð¸ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾."
    print(json.dumps(reader.analyze_text(sample_text), indent=2, ensure_ascii=False))
